pico-8 cartridge // http://www.pico-8.com
version 17
__lua__
-- hoppy road
-- by josh and opal

splash=61

function _init()
 time=0
 sprites={}
 for x=0,16 do
  for y=0,16 do
   tile=mget(x,y)
   if isbunny(x,y) then
    bunny=make_sprite(tile,x,y)
    bunny.update=bunny_update
    bunny.ntiles=8
    mset(x,y,mget(x-1,y))
   end
   if iscar(x,y) then
    car=make_sprite(tile,x,y)
    car.vx=(1+tile-32)/32
    car.update=car_update
    mset(x,y,mget(x-1,y))
   end
   if isperson(x,y) then
    s=make_sprite(tile,x,y)
    s.vx=-rnd(3)/32
    s.update=car_update
    mset(x,y,mget(x-1,y))
   end
   if issolid(x,y) then
    s=make_sprite(tile,x,y)
    mset(x,y,mget(x-1,y))
   end
  end
 end
end

function issolid(x,y)
 tile=mget(x,y)
 return fget(tile,0)
end

function isbunny(x,y)
 tile=mget(x,y)
 return fget(tile,1)
end

function iscar(x,y)
 tile=mget(x,y)
 return fget(tile,2)
end

function isperson(x,y)
 tile=mget(x,y)
 return fget(tile,3)
end

function iswater(x,y)
 tile=mget(x,y)
 return fget(tile,4)
end

function make_sprite(tile,x,y)
 local s={}
 s.tile=tile
 s.tile0=tile
 s.ntiles=1
 s.x=x s.y=y
 s.vx=0 s.vy=0
 s.draw=draw_sprite
 s.update=nil
 s.hasshadow=false
 add(sprites,s)
 return s
end

function overlaps(a,b)
 return (abs(a.x-b.x)<1 and
         abs(a.y-b.y)<1)
end

function make_splash(x,y)
 if time%8!=0 then return end
 s=make_sprite(splash,x,y)
 s.life=10
 --s.vy=-2/8
 --s.vx=(rnd(4)-2)/8
 s.update=update_splash
end

function update_splash(s)
 s.life-=1
 if s.life<=0 then
  del(sprites,s)
 end
 s.x+=s.vx
 s.y+=s.vy
 --s.vy+=1/16
end

function car_update(c)
 c.x+=c.vx
 c.y+=c.vy
 if c.x>16 then
  c.x=-1
 end
 if c.x<-2 then
  c.x=16
 end
 bump(c)
 if iswater(c.x,c.y) then
  make_splash(c.x,c.y)
 end
end

function bump(b)
 mesolid=fget(b.tile,0)
 if not mesolid then return end
 for s in all(sprites) do
  solid=fget(s.tile,0)
  if s!=b and solid and overlaps(s,b) then
   if sgn(s.x-b.x)==sgn(b.vx) then
    b.vx*=-1
    b.x+=b.vx
   end
   if sgn(s.y-b.y)==sgn(b.vy) then
    b.vy*=-1
    b.y+=b.vy
   end
   if fget(s.tile,5) then
    s.tile+=2
   end
  end
 end
end

function bunny_update(b)
 local speed=1/8
 if btnp(0) then b.vx=-speed end
 if btnp(1) then b.vx=speed end
 if btnp(2) then b.vy=-speed end
 if btnp(3) then b.vy=speed end
 b.x+=b.vx
 b.y+=b.vy
 
 bump(b)
 
 if b.x==flr(b.x) then b.vx=0 end
 if b.y==flr(b.y) then b.vy=0 end
 b.tile=b.tile0+time/4%b.ntiles
 if iswater(b.x,b.y) then
  make_splash(b.x,b.y)
 end
end

function _update60()
 for s in all(sprites) do
  if s.update~=nil then
   s:update()
  end
 end
 time+=1
end

function draw_sprite(s)
 spr(s.tile,s.x*8,s.y*8-4,1,1,s.vx<0)
 if s.hasshadow then
  x=s.x*8
  y=s.y*8+4
  line(x+2,y,x+6,y,1)
 end
end

function _draw()
 cls()
 mapdraw(0,0,0,0,16,16)
 for s in all(sprites) do
  s:draw()
 end
end






__gfx__
0000000055555555bbbbbbbb000000005555555500000000000000000000000000a00a000c0c0c000077bbbb0f0f0f000000000044400000000440000a0a0a00
0000000055555555b3bbbb3b00333300555ccc55003333000000000000900900408288040ccccccc0b71bbbb0888888f0000000004040000000040000c0c0c00
0000000055555555bbbbbbbb038333305cccccc503333330000000000099990008888280cc71c7100bbbb707f827827000710710004040000878488077777777
0000000055555555bbbbbbbb03333830cccccccc033333300000000099979994888788820c71c71cbbb700000827827f0071071000400880878888887efeeefe
0000000057755775bbbbb3bb033333305cccccc503333330000000000922224008222220ccccccc0bbb00000f88888800000000008808788878888887eeefeee
0000000055555555bb3bbbbb003833005cccccc5003333000000000003c88c3003c88c300ccccccc0bbbb0700888888f00000000878888888888888877777777
0000000055555555bbbbbbb300044000555cccc50004400000000000b03cc30bb03cc30bccccccc00bbbbbbbf88888800000000088880880088888807efeefee
0000000055555555bbbbbbbb0004400055555555000440000000000000b33b0000b33b0000c0c0c0000bbbbb00f0f0f00000000008800000008888007eeeeeee
0000000007707700007707700000000000000000007707700770770000000000000000004444400000000000000000000011100000ccc0000b0b0b0000999000
0770770007e07e00007e07e00077077000770770007e07e007e07e00077077000000000002444400007666000000000001111110ccccccc00bbbbb0099999990
07e07e000777770000777770007e07e0007e07e0007777700777770007e07e00000000000241f106076565060011110611f1f10001f1f1060bf1f10605f1f106
07777700071717000071717000777770007777700071717007171700077777000000000002ffff06066fff06011fff0611ffff0001ffff06bbffff0605ffff06
071717000777770000777770007171700071717000777770077777000717170000000000022444060665650601111106112ee00001ccc106b2a9a40605333506
07777700077777000077777000777770007777700077777007777700077777000000000041111144556555551111111111999000c11111ccf49a942f35555533
077777000777770000777770007777700077777000777770077777000777770000000000022444060111110601111106022ee20001ddd1060999940605333506
077777000000000000000000007777700077777000000000000000000777770000000000010001000600050001000100222eee20010001009200290005000500
0000000000000000000000000000000000000000000878000008c00008787878000000000000000000000000bbbbb666666bbbbb000000000000000000000000
e7eeeee000888000003330000009990044444440787777700077700088888880000000000000000000000000bbb666cccc666bbb000000000000000000000000
777eccc008c8c80003c3c3000009cc904444ccc08887ccc007c7c7008888ccc0000000000000000000000000bb66cccccccc66bb000000000000000000000000
444eccc08cc8cc803cc3cc300009cc904444ccc07877ccc07cc7cc708888ccc0000000000000000000000000b66cccccccccc66b000000000000000000000000
e4eeeee788888887333333379999999744444447777777775aa5555588888888000000000000000000000000b6cccccccccccc6b000000000000000000000000
eeeeeeee88888888333333339999999944444444888888887aa555778888888800000000000000000000000066cccccccccccc66000000000000000000000000
e11ee11e811881183113311391199119411441147117711771175117811881180000000000000000000000006cccccccccccccc6000000000000000000000000
01100110011001100110011001100110011001100110011001100110011001100000000000000000000000006cccccccccccccc6000000000000000000000000
0077770004444400099999900c0c0c000ccccc000000000000000000001111000999990000000000000000006cccccccccccccc6000000000000000000000000
07cccc0044999990994944900c333300ccc77cc0000e000000000000014444009977779000000000000000006cccccccccccccc6000000000000000000000000
07c1c10044f2f2409941410003313100cc7070c0e0eee0e0500000500141410099cc7700000000000000000066cccccccccccc66000000000000000000000000
0cc1c10044f2f24099414100333131c0cc707000eeeeeee0505550500441410099ccc7000000000000000000b6cccccccccccc6b000000000000000000000000
0dcccc0004ffff0008444400c3333330077777000ee7ee00058585000a444400034444000000000000000000b66cccccccccc66b000000000000000000000000
cdddddc0944444908888888002222200c99999c0e77777e0005550004aaaaa4043bbbb400000000000000000bb66cccccccc66bb000000000000000000000000
04444400044444000e88e000033233000aaaaa00ee777ee0055555000ccccc00033bb3000000000000000000bbb666cccc666bbb077007700000000000000000
0c000c00099099000ee0ee0003c03c000c000c000eeeee000500050004000400033033000000000000000000bbbbb666666bbbbb700770070000000000000000
__gff__
0000002110010009090909090800000003010101010100000009090909090909050505050505050500000010100000000909090909090909090000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020302020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101012201010101010101010101270100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101210101010120010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020302020203020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0122010101240101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101012501010101230101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020303020302022b2c023002020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202363b3c020203020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0203020203330202030202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010122010101012101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0203020202020202020203022b2c023700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202320202030202330202343b3c020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0120010101010401010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020333020202020202310202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020210020302020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
